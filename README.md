# Increase Coverage Action

[![GitHub version](https://badge.fury.io/gh/taylorlroberts7%2Fincrease-coverage-action.svg)](https://badge.fury.io/gh/taylorlroberts7%2Fincrease-coverage-action)
[![Commitizen friendly](https://img.shields.io/badge/commitizen-friendly-brightgreen.svg)](http://commitizen.github.io/cz-cli/)

This action will dynamically increase your code coverage thresholds after code coverage is reported. Since this action relies on your test runner job to run first (`needs: [test]`), it will only run if your test coverage meets or beats the coverage thresholds set at the time of the tests being ran.

---

## Table of Contents

- [Usage](#usage)
  - [Caching](#caching)
  - [Committing Coverage Changes](#committing-coverage-changes)
  - [Using This Action with Other Test Coverage Tools](#using-this-action-with-other-test-coverage-tools)
- [Inputs](#inputs)
- [Outputs](#outputs)
- [Examples](#examples)
  - [Caching in Test Job](#caching-in-test-job)
  - [Running Increase Coverage Action](#running-increase-coverage-action)
  - [Using this action with Istanbul/nyc](#using-this-action-with-istanbul--nyc)

---

## Usage

### Caching

‚ùóÔ∏è This action reads the config and summary files from the GitHub action cache so it _must_ be used in combination with the [GitHub cache action](https://github.com/actions/cache).

- The cache `key` input used with the `actions/cache` step must match the key inputs (`config-key` and `summary-key`) provided to this action
- The cache `path` input used with the `actions/cache` step must match the path inputs (`config-path` and `summary-path`) provided to this action
- [See example below](#caching-in-test-job).

### Committing Coverage Changes

You can use this action in combination with the [Add & Commit action](https://github.com/EndBug/add-and-commit) to commit the config file with the updated code coverage thresholds.

- If you only want to run this action when PR branches are merged, you can add this line to the job block:
  ```yml
  if: github.ref == 'refs/heads/main'
  ```
- [See example below](#running-increase-coverage-action)
- **Note**: If your main branch is protected, you will need to pass a GitHub token to `actions/checkout`:
  ```yml
  - name: Checkout
    uses: actions/checkout@v2
    with:
      token: ${{ secrets.GH_TOKEN }}
  ```
  - In this case, you'll want to prevent action loops on your main branch by telling GitHub to ignore changes to your config json files:
    ```yml
    on:
      push:
        branches:
          - main
          - production
        paths:
          - "!**.config.local.json"
    ```

### Using This Action with Other Test Coverage Tools

By default, this action works with Jest's code coverage configuration ([`coverageThreshold` object](https://jestjs.io/docs/configuration#coveragethreshold-object)). However, you can pull the coverage thresholds from the config file written by this action and apply them to other coverage configuation tools like IstanbulJS/nyc.

- [See example below](#using-this-action-with-istanbul--nyc)

---

## Inputs

| Variable       | Description                                                         | Example                                   | Required? |
| -------------- | ------------------------------------------------------------------- | ----------------------------------------- | --------- |
| `config-key`   | Cache key used for caching config file in test runner job           | `${{ runner.os }}-cache-jest-config`      | Yes       |
| `config-path`  | Path to your test config file                                       | `jest.config.local.json`                  | Yes       |
| `summary-key`  | Cache key used for caching coverage summary file in test runner job | `${{ runner.os }}-cache-coverage-summary` | Yes       |
| `summary-path` | Path to generated code coverage summary JSON file                   | `coverage/coverage-summary.json`          | Yes       |

---

## Outputs

This action will write to the config file passed in (pulled from GH action cache) with the updated coverage threshold values from the coverage summary file.

<details>
  <summary markdown="span">Original config file (e.g. `jest.config.local.json`)</summary>

```json
{
  "coverageThreshold": {
    "global": {
      "branches": 77,
      "functions": 79,
      "lines": 79,
      "statements": 79
    },
    "./src/App.tsx": {
      "branches": 80,
      "functions": 80,
      "lines": 80,
      "statements": 80
    }
  }
}
```

</details>

<details>
  <summary markdown="span">Coverage summary generated by test run (e.g. `coverage/coverage-summary.json`)</summary>

```json
{
  "total": {
    "lines": {
      "total": 630,
      "covered": 461,
      "skipped": 0,
      "pct": 80
    },
    "statements": {
      "total": 740,
      "covered": 543,
      "skipped": 0,
      "pct": 81
    },
    "functions": {
      "total": 140,
      "covered": 58,
      "skipped": 0,
      "pct": 81
    },
    "branches": {
      "total": 321,
      "covered": 182,
      "skipped": 0,
      "pct": 81
    }
  },
  "/Users/taylorroberts/Documents/academic-portal-host/src/App.tsx": {
    "lines": {
      "total": 9,
      "covered": 8,
      "skipped": 0,
      "pct": 80
    },
    "functions": {
      "total": 1,
      "covered": 1,
      "skipped": 0,
      "pct": 80
    },
    "statements": {
      "total": 10,
      "covered": 9,
      "skipped": 0,
      "pct": 80
    },
    "branches": {
      "total": 4,
      "covered": 2,
      "skipped": 0,
      "pct": 80
    }
  }
}
```

</details>

<details>
  <summary markdown="span">Updated config file written to by increase coverage action (e.g. `jest.config.local.json`)</summary>

```json
{
  "coverageThreshold": {
    "global": {
      "branches": 81,
      "functions": 81,
      "lines": 80,
      "statements": 81
    },
    "./src/App.tsx": {
      "branches": 80,
      "functions": 80,
      "lines": 80,
      "statements": 80
    }
  }
}
```

</details>

---

## Examples

### Caching in Test Job

Caching test config and coverage summary files in test runner job

```yml
test:
  runs-on: ubuntu-20.04
  container: node:16
  needs: [install_dependencies]
  steps:
    - name: Checkout
      uses: actions/checkout@v2
    # üëâ Cache coverage summary here
    - name: Cache Coverage Summary
      uses: actions/cache@v3
      env:
        cache-name: cache-coverage-summary
      with:
        key: ${{ runner.os }}-${{ env.cache-name }}
        path: coverage/coverage-summary.json
    # üëâ Cache test config file here
    - name: Cache Jest Config
      uses: actions/cache@v2
      env:
        cache-name: cache-jest-config
      with:
        key: ${{ runner.os }}-${{ env.cache-name }}-${{ hashFiles('jest.config.local.json') }}
        path: jest.config.local.json
    # Run test with coverage reporting on
    - name: Testing code
      run: yarn test:coverage
```

### Running Increase Coverage Action

```yml
increase-test-coverage:
  runs-on: ubuntu-latest
  container: node:16
  # üëâ Add the name of your test job here to ensure this runs after
  needs: [install_dependencies, test]
  # üëâ Run this when PR branches are merged to main
  if: github.ref == 'refs/heads/main'
  steps:
    - name: Checkout
      uses: actions/checkout@v2
    - name: Increase Jest Coverage
      # üö® Use most recent version!
      uses: taylorlroberts7/increase-coverage-action@v1.0.0
      with:
        config-key: ${{ runner.os }}-cache-jest-config-${{ hashFiles('jest.config.local.json') }}
        config-path: jest.config.local.json
        summary-key: ${{ runner.os }}-cache-coverage-summary
        summary-path: coverage/coverage-summary.json
    # üëâ Commit changes to your config file (if any changes made)
    - name: Commit Jest Config
      uses: EndBug/add-and-commit@v7
      with:
        default_author: github_actions
```

### Using this action with Istanbul + nyc

- `nyc.config.local.json` (Use this file with the increase coverage action)

  ```json
  {
    "coverageThreshold": {
      "global": {
        "branches": 81,
        "functions": 80,
        "lines": 80,
        "statements": 80
      },
      "./src/App.tsx": {
        "branches": 80,
        "functions": 80,
        "lines": 80,
        "statements": 80
      }
    }
  }
  ```

- `nyc.config.js` (nyc configuration file)

  ```js
  const local = require("./nyc.config.local");

  const defaultConfig = {
    all: true,
    "check-coverage": true,
    exclude: ["**/__mocks__", "**/__tests__"],
    extends: "@istanbuljs/nyc-config-typescript",
    include: ["src/**"],
    "report-dir": "my-coverage",
  };

  // Pull global coverage thresholds from file that the increase coverage action writes to
  module.exports = Object.assign(defaultConfig, local.coverageThreshold.global);
  ```
